<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLACK HOLE SPLITTER</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            padding: 20px;
        }
        
        .title {
            text-align: center;
            margin-bottom: 60px;
        }
        
        .title h1 {
            font-size: 2.5em;
            font-weight: 700;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }
        
        .title h2 {
            font-size: 1.2em;
            font-weight: 300;
            letter-spacing: 8px;
            opacity: 0.8;
        }
        
        .black-hole {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #333 0%, #1a1a1a 50%, #000 100%);
            border: 2px solid #555;
            box-shadow: 
                0 0 30px rgba(255, 255, 255, 0.1),
                inset 0 0 30px rgba(0, 0, 0, 0.8),
                0 0 60px rgba(0, 0, 0, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            margin-bottom: 60px;
        }
        
        .black-hole:hover {
            transform: scale(1.05);
            box-shadow: 
                0 0 40px rgba(255, 255, 255, 0.2),
                inset 0 0 40px rgba(0, 0, 0, 0.9),
                0 0 80px rgba(0, 0, 0, 0.7);
        }
        
        .black-hole:active {
            transform: scale(0.95);
        }
        
        .black-hole::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle, #444 0%, #222 70%, #000 100%);
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.8);
        }
        
        .black-hole::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #000;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.9);
        }
        
        .videos-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .videos-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        
        .videos-icon::before {
            content: '‚óè';
            color: #ffd700;
            font-size: 20px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
        }
        
        .videos-text {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 2px;
            color: #ffd700;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            flex-direction: column;
            align-items: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: white;
            font-size: 16px;
            font-weight: 500;
        }
        
        .result {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            flex-direction: column;
            align-items: center;
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 300px;
            text-align: center;
        }
        
        .result.success {
            border-color: rgba(76, 175, 80, 0.5);
        }
        
        .result.error {
            border-color: rgba(244, 67, 54, 0.5);
        }
        
        .result h3 {
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .result.success h3 {
            color: #4caf50;
        }
        
        .result.error h3 {
            color: #f44336;
        }
        
        .result p {
            margin-bottom: 10px;
            font-size: 14px;
            opacity: 0.8;
        }
        
        .download-btn {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.7;
        }
        
        .close-btn:hover {
            opacity: 1;
        }
        
        .url-input {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            flex-direction: column;
            align-items: center;
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 400px;
            width: 90%;
        }
        
        .url-input input {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .url-input input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .url-input input:focus {
            outline: none;
            border-color: #ffd700;
        }
        
        .url-buttons {
            display: flex;
            gap: 15px;
        }
        
        .url-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .url-btn.primary {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
        }
        
        .url-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .url-btn:hover {
            transform: translateY(-2px);
        }
        
        .format-selection {
            display: none;
            flex-direction: column;
            align-items: center;
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 450px;
            width: 90%;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .format-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            margin: 20px 0;
        }
        
        .format-option {
            display: flex;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .format-option:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #ffd700;
        }
        
        .format-option.selected {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffd700;
        }
        
        .format-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 18px;
        }
        
        .format-icon.video {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
        }
        
        .format-icon.audio {
            background: linear-gradient(45deg, #4ecdc4, #6dd5ed);
        }
        
        .format-info {
            flex: 1;
        }
        
        .format-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .format-details {
            font-size: 12px;
            opacity: 0.7;
        }
        
        .progress-container {
            display: none;
            flex-direction: column;
            align-items: center;
            background: rgba(0, 0, 0, 0.95);
            padding: 40px;
            border-radius: 25px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 450px;
            width: 90%;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }
        
        .progress-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .progress-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 24px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .progress-info {
            flex: 1;
        }
        
        .progress-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffd700;
            margin-bottom: 5px;
        }
        
        .progress-subtitle {
            font-size: 14px;
            opacity: 0.7;
        }
        
        .progress-bar-container {
            width: 100%;
            margin: 25px 0;
            position: relative;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ffd700, #4ecdc4);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .progress-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-top: 15px;
        }
        
        .progress-percentage {
            font-size: 24px;
            font-weight: 700;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .progress-speed {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .recent-downloads {
            display: none;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 600px;
            width: 90%;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .download-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .download-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #ffd700;
        }
        
        .download-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 18px;
        }
        
        .download-icon.video {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
        }
        
        .download-icon.audio {
            background: linear-gradient(45deg, #4ecdc4, #6dd5ed);
        }
        
        .download-info {
            flex: 1;
        }
        
        .download-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: white;
        }
        
        .download-details {
            font-size: 12px;
            opacity: 0.7;
            display: flex;
            gap: 15px;
        }
        
        .download-actions {
            display: flex;
            gap: 10px;
        }
        
        .download-btn-small {
            padding: 8px 12px;
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid #ffd700;
            border-radius: 6px;
            color: #ffd700;
            text-decoration: none;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .download-btn-small:hover {
            background: rgba(255, 215, 0, 0.3);
            transform: translateY(-1px);
        }
        
        .audio-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .volume-slider {
            width: 150px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #ffd700;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .volume-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #ffd700;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .volume-icon {
            font-size: 20px;
            color: #ffd700;
        }
    </style>
</head>
<body>
    <!-- Main Container -->
    <div class="container">
        <div class="title">
            <h1>BLACK HOLE</h1>
            <h2>SPLITTER</h2>
        </div>
        
        <div class="black-hole" id="blackHole"></div>
        
        <div class="videos-button" id="videosButton">
            <div class="videos-icon"></div>
            <div class="videos-text">VIDEOS</div>
        </div>
    </div>
    
    <!-- URL Input Modal -->
    <div class="url-input" id="urlInput">
        <button class="close-btn" id="closeUrlInput">&times;</button>
        <h3 style="margin-bottom: 20px; color: #ffd700;">Enter Video URL</h3>
        <input type="url" id="videoUrl" placeholder="Paste video URL here...">
        <div class="url-buttons">
            <button class="url-btn secondary" id="cancelUrl">Cancel</button>
            <button class="url-btn primary" id="extractUrl">Extract</button>
        </div>
    </div>
    
    <!-- Format Selection Modal -->
    <div class="format-selection" id="formatSelection">
        <button class="close-btn" id="closeFormatSelection">&times;</button>
        <h3 style="margin-bottom: 20px; color: #ffd700;">Choose Format</h3>
        <div id="videoTitle" style="margin-bottom: 20px; text-align: center; opacity: 0.8;"></div>
        <div class="format-options" id="formatOptions">
            <!-- Format options will be populated here -->
        </div>
        <div class="url-buttons">
            <button class="url-btn secondary" id="backToUrl">Back</button>
            <button class="url-btn primary" id="downloadSelected">Download</button>
        </div>
    </div>
    
    <!-- Progress Modal -->
    <div class="progress-container" id="progressContainer">
        <div class="progress-header">
            <div class="progress-icon" id="progressIcon">‚¨áÔ∏è</div>
            <div class="progress-info">
                <div class="progress-title" id="progressTitle">Downloading...</div>
                <div class="progress-subtitle" id="progressSubtitle">Preparing download...</div>
            </div>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
        <div class="progress-details">
            <div class="progress-percentage" id="progressPercentage">0%</div>
            <div class="progress-speed" id="progressSpeed">0 MB/s</div>
        </div>
    </div>
    
    <!-- Recent Downloads Modal -->
    <div class="recent-downloads" id="recentDownloads">
        <button class="close-btn" id="closeRecentDownloads">&times;</button>
        <h3 style="margin-bottom: 20px; color: #ffd700;">Recent Downloads</h3>
        <div id="downloadsList">
            <!-- Download items will be populated here -->
        </div>
        <div class="url-buttons" style="margin-top: 20px;">
            <button class="url-btn secondary" id="clearDownloads">Clear All</button>
            <button class="url-btn primary" id="newDownload">New Download</button>
        </div>
    </div>
    
    <!-- Audio Controls -->
    <div class="audio-controls" id="audioControls">
        <div class="volume-icon" id="volumeIcon">üîä</div>
        <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="50">
        <div style="font-size: 12px; opacity: 0.7;" id="volumeValue">50%</div>
    </div>
    
    <!-- Loading Modal -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Processing video...</div>
    </div>
    
    <!-- Result Modal -->
    <div class="result" id="result">
        <button class="close-btn" id="closeResult">&times;</button>
        <div id="resultContent"></div>
    </div>

    <script>
        // Check if URL is in clipboard
        async function checkClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                console.log('Clipboard content:', text);
                if (text && (text.includes('youtube.com') || text.includes('instagram.com') || text.includes('tiktok.com') || text.includes('vimeo.com'))) {
                    console.log('Valid video URL found in clipboard:', text);
                    return text;
                }
            } catch (err) {
                console.log('Clipboard access denied:', err);
            }
            return null;
        }
        
        // Global variables
        let currentVideoInfo = null;
        let selectedFormat = null;
        let downloadHistory = JSON.parse(localStorage.getItem('downloadHistory') || '[]');
        let currentAudio = null;
        
        // Show URL input
        function showUrlInput() {
            document.getElementById('urlInput').style.display = 'flex';
            
            // Add iOS indicator if detected
            if (isIOS()) {
                const urlInput = document.getElementById('urlInput');
                let iosIndicator = document.getElementById('iosIndicator');
                if (!iosIndicator) {
                    iosIndicator = document.createElement('div');
                    iosIndicator.id = 'iosIndicator';
                    iosIndicator.style.cssText = `
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        background: rgba(255, 215, 0, 0.2);
                        border: 1px solid #ffd700;
                        border-radius: 15px;
                        padding: 5px 10px;
                        font-size: 12px;
                        color: #ffd700;
                    `;
                    iosIndicator.textContent = 'üì± iOS Mode';
                    urlInput.style.position = 'relative';
                    urlInput.appendChild(iosIndicator);
                }
            }
        }
        
        // Hide URL input
        function hideUrlInput() {
            document.getElementById('urlInput').style.display = 'none';
        }
        
        // Show format selection
        function showFormatSelection() {
            document.getElementById('formatSelection').style.display = 'flex';
        }
        
        // Hide format selection
        function hideFormatSelection() {
            document.getElementById('formatSelection').style.display = 'none';
        }
        
        // Show progress
        function showProgress() {
            document.getElementById('progressContainer').style.display = 'flex';
        }
        
        // Hide progress
        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }
        
        // Update progress with enhanced UI
        function updateProgress(percentage, title, subtitle, speed = '') {
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressPercentage').textContent = Math.round(percentage) + '%';
            if (title) {
                document.getElementById('progressTitle').textContent = title;
            }
            if (subtitle) {
                document.getElementById('progressSubtitle').textContent = subtitle;
            }
            if (speed) {
                document.getElementById('progressSpeed').textContent = speed;
            }
            
            // Update progress icon based on percentage
            const icon = document.getElementById('progressIcon');
            if (percentage < 25) {
                icon.textContent = '‚è≥';
            } else if (percentage < 50) {
                icon.textContent = '‚¨áÔ∏è';
            } else if (percentage < 75) {
                icon.textContent = 'üì•';
            } else if (percentage < 100) {
                icon.textContent = '‚ö°';
            } else {
                icon.textContent = '‚úÖ';
            }
        }
        
        // Show recent downloads
        function showRecentDownloads() {
            document.getElementById('recentDownloads').style.display = 'flex';
            loadDownloadHistory();
        }
        
        // Hide recent downloads
        function hideRecentDownloads() {
            document.getElementById('recentDownloads').style.display = 'none';
        }
        
        // Load download history
        function loadDownloadHistory() {
            const downloadsList = document.getElementById('downloadsList');
            downloadsList.innerHTML = '';
            
            if (downloadHistory.length === 0) {
                downloadsList.innerHTML = '<div style="text-align: center; opacity: 0.7; padding: 40px;">No downloads yet. Start downloading to see your history here!</div>';
                return;
            }
            
            downloadHistory.forEach((download, index) => {
                const downloadItem = createDownloadItem(download, index);
                downloadsList.appendChild(downloadItem);
            });
        }
        
        // Create download item element
        function createDownloadItem(download, index) {
            const item = document.createElement('div');
            item.className = 'download-item';
            
            const isAudio = download.format === 'mp3' || download.format === 'aac';
            const iconClass = isAudio ? 'audio' : 'video';
            const icon = isAudio ? 'üéµ' : 'üé¨';
            
            item.innerHTML = `
                <div class="download-icon ${iconClass}">
                    ${icon}
                </div>
                <div class="download-info">
                    <div class="download-title">${download.title}</div>
                    <div class="download-details">
                        <span>${download.format.toUpperCase()}</span>
                        <span>${(download.size / (1024 * 1024)).toFixed(1)} MB</span>
                        <span>${new Date(download.date).toLocaleDateString()}</span>
                    </div>
                </div>
                <div class="download-actions">
                    <a href="${download.url}" class="download-btn-small" download>Download</a>
                    ${isAudio ? `<button class="download-btn-small" onclick="playAudio('${download.url}')">Play</button>` : ''}
                    <button class="download-btn-small" onclick="removeDownload(${index})" style="background: rgba(255, 0, 0, 0.2); border-color: #ff4444; color: #ff4444;">Delete</button>
                </div>
            `;
            
            return item;
        }
        
        // Add download to history
        function addToDownloadHistory(downloadInfo) {
            const download = {
                title: currentVideoInfo.title,
                url: downloadInfo.download_url,
                format: selectedFormat.outputFormat,
                size: downloadInfo.filesize,
                date: new Date().toISOString()
            };
            
            downloadHistory.unshift(download);
            
            // Keep only last 20 downloads
            if (downloadHistory.length > 20) {
                downloadHistory = downloadHistory.slice(0, 20);
            }
            
            localStorage.setItem('downloadHistory', JSON.stringify(downloadHistory));
        }
        
        // Remove download from history
        function removeDownload(index) {
            downloadHistory.splice(index, 1);
            localStorage.setItem('downloadHistory', JSON.stringify(downloadHistory));
            loadDownloadHistory();
        }
        
        // Clear all downloads
        function clearAllDownloads() {
            if (confirm('Are you sure you want to clear all download history?')) {
                downloadHistory = [];
                localStorage.setItem('downloadHistory', JSON.stringify(downloadHistory));
                loadDownloadHistory();
            }
        }
        
        // iOS-specific download handler
        function handleIOSDownload(url, filename, isAudio = false) {
            if (isIOS()) {
                if (isAudio) {
                    // For audio files, create an audio player
                    const audio = document.createElement('audio');
                    audio.src = url;
                    audio.controls = true;
                    audio.preload = 'metadata';
                    audio.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        width: 90%;
                        max-width: 400px;
                        height: 60px;
                        z-index: 10000;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border-radius: 15px;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                        padding: 20px;
                    `;
                    
                    // Add iOS-specific attributes for better audio handling
                    audio.setAttribute('webkit-playsinline', 'true');
                    audio.setAttribute('playsinline', 'true');
                    
                    // Add close button
                    const closeBtn = document.createElement('button');
                    closeBtn.innerHTML = '‚úï';
                    closeBtn.style.cssText = `
                        position: absolute;
                        top: -10px;
                        right: -10px;
                        background: #ff4444;
                        color: white;
                        border: none;
                        border-radius: 50%;
                        width: 30px;
                        height: 30px;
                        font-size: 16px;
                        cursor: pointer;
                        z-index: 10001;
                    `;
                    closeBtn.onclick = () => {
                        document.body.removeChild(audio);
                        document.body.removeChild(closeBtn);
                        document.body.removeChild(overlay);
                    };
                    
                    // Add overlay
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        z-index: 9999;
                    `;
                    overlay.onclick = () => {
                        document.body.removeChild(overlay);
                        document.body.removeChild(audio);
                        document.body.removeChild(closeBtn);
                    };
                    
                    // Add to page
                    document.body.appendChild(overlay);
                    document.body.appendChild(audio);
                    document.body.appendChild(closeBtn);
                    
                    // Show instructions for audio
                    setTimeout(() => {
                        alert('üéµ iOS Audio Instructions:\n\n1. The audio is now playing above\n2. Tap and hold on the audio player\n3. Select "Save to Files" from the menu\n4. Choose "Music" folder in Files app\n5. Later: Import to Apple Music via iTunes/Music app\n\nNote: Direct Apple Music import requires iTunes on computer');
                    }, 500);
                    
                } else {
                    // For video files, create a video element
                    const video = document.createElement('video');
                    video.src = url;
                    video.controls = true;
                    video.playsInline = true; // Important for iOS
                    video.preload = 'metadata';
                    video.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        width: 90%;
                        max-width: 500px;
                        height: auto;
                        z-index: 10000;
                        background: black;
                        border-radius: 10px;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                    `;
                    
                    // Add iOS-specific attributes
                    video.setAttribute('webkit-playsinline', 'true');
                    video.setAttribute('playsinline', 'true');
                    
                    // Add close button
                    const closeBtn = document.createElement('button');
                    closeBtn.innerHTML = '‚úï';
                    closeBtn.style.cssText = `
                        position: absolute;
                        top: -10px;
                        right: -10px;
                        background: #ff4444;
                        color: white;
                        border: none;
                        border-radius: 50%;
                        width: 30px;
                        height: 30px;
                        font-size: 16px;
                        cursor: pointer;
                        z-index: 10001;
                    `;
                    closeBtn.onclick = () => {
                        document.body.removeChild(video);
                        document.body.removeChild(closeBtn);
                        document.body.removeChild(overlay);
                    };
                    
                    // Add overlay
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        z-index: 9999;
                    `;
                    overlay.onclick = () => {
                        document.body.removeChild(overlay);
                        document.body.removeChild(video);
                        document.body.removeChild(closeBtn);
                    };
                    
                    // Add to page
                    document.body.appendChild(overlay);
                    document.body.appendChild(video);
                    document.body.appendChild(closeBtn);
                    
                    // Show instructions for video
                    setTimeout(() => {
                        alert('üì± iOS Video Instructions:\n\n1. The video is now playing above\n2. Tap and hold on the video\n3. Select "Save to Photos" from the menu\n4. Tap the ‚úï to close when done\n\nYour video will be saved to your Photos app!');
                    }, 500);
                }
                
            } else {
                // For other devices, use normal download
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        
        // Play audio
        function playAudio(url) {
            if (currentAudio) {
                currentAudio.pause();
            }
            
            currentAudio = new Audio(url);
            currentAudio.volume = document.getElementById('volumeSlider').value / 100;
            currentAudio.play();
            
            // Show audio controls
            document.getElementById('audioControls').style.display = 'flex';
            
            // Update volume icon based on volume level
            updateVolumeIcon();
        }
        
        // Update volume icon
        function updateVolumeIcon() {
            const volume = document.getElementById('volumeSlider').value;
            const icon = document.getElementById('volumeIcon');
            
            if (volume == 0) {
                icon.textContent = 'üîá';
            } else if (volume < 30) {
                icon.textContent = 'üîà';
            } else if (volume < 70) {
                icon.textContent = 'üîâ';
            } else {
                icon.textContent = 'üîä';
            }
        }
        
        // Show loading
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }
        
        // Hide loading
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        // Show result
        function showResult(content, isSuccess = true) {
            const result = document.getElementById('result');
            const resultContent = document.getElementById('resultContent');
            
            result.className = `result ${isSuccess ? 'success' : 'error'}`;
            resultContent.innerHTML = content;
            result.style.display = 'flex';
        }
        
        // Hide result
        function hideResult() {
            document.getElementById('result').style.display = 'none';
        }
        
        // Validate URL
        function isValidVideoUrl(url) {
            const validDomains = ['youtube.com', 'youtu.be', 'instagram.com', 'tiktok.com', 'vimeo.com', 'twitter.com', 'x.com'];
            return validDomains.some(domain => url.includes(domain));
        }
        
        // Extract video info and show format selection
        async function extractVideoInfo(url) {
            showLoading();
            hideUrlInput();
            
            try {
                console.log('Extracting video info for URL:', url);
                
                // Validate URL first
                if (!isValidVideoUrl(url)) {
                    console.error('URL validation failed for:', url);
                    throw new Error('Please enter a valid video URL from YouTube, Instagram, TikTok, or Vimeo');
                }
                
                // Extract video info
                const extractResponse = await fetch('/extract', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url })
                });
                
                if (!extractResponse.ok) {
                    const errorText = await extractResponse.text();
                    throw new Error('Failed to extract video info: ' + errorText);
                }
                
                const videoInfo = await extractResponse.json();
                console.log('Video info:', videoInfo);
                
                // Store video info globally
                currentVideoInfo = { ...videoInfo, url: url };
                
                // Show format selection
                showFormatOptions(videoInfo);
                hideLoading();
                showFormatSelection();
                
            } catch (error) {
                console.error('Extract error:', error);
                hideLoading();
                
                let errorMessage = error.message;
                if (errorMessage.includes('Failed to extract video info')) {
                    errorMessage = 'Unable to process this video URL. Please try a different video.';
                } else if (errorMessage.includes('Domain not allowed')) {
                    errorMessage = 'This website is not supported. Please try YouTube, Instagram, TikTok, or Vimeo.';
                }
                
                const content = `
                    <h3>‚ùå Error</h3>
                    <p>${errorMessage}</p>
                    <p>Please try a different video URL.</p>
                `;
                showResult(content, false);
            }
        }
        
        // Show format options
        function showFormatOptions(videoInfo) {
            document.getElementById('videoTitle').textContent = videoInfo.title;
            
            const formatOptions = document.getElementById('formatOptions');
            formatOptions.innerHTML = '';
            
            // Add video format options
            const videoFormats = videoInfo.formats.filter(f => f.vcodec && f.vcodec !== 'none' && f.acodec && f.acodec !== 'none');
            if (videoFormats.length > 0) {
                // Best video format (WebM preferred)
                const bestVideo = videoFormats.sort((a, b) => (b.quality || 0) - (a.quality || 0))[0];
                const videoOption = createFormatOption('video', 'Video (WebM)', `${bestVideo.ext.toUpperCase()} (${bestVideo.resolution || 'Best Quality'})`, 'bestvideo[ext=webm]+bestaudio[ext=webm]/bestvideo[ext!=mp4]+bestaudio[ext!=mp4]/bestvideo+bestaudio/best');
                formatOptions.appendChild(videoOption);
                
                // iPhone-optimized format (MP4)
                const iphoneOption = createFormatOption('video', 'Video (iPhone Optimized)', 'MP4 (H.264) - Direct Photos compatibility', 'bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best');
                formatOptions.appendChild(iphoneOption);
            }
            
            // Add audio format options
            const audioFormats = videoInfo.formats.filter(f => f.acodec && f.acodec !== 'none' && f.vcodec === 'none');
            if (audioFormats.length > 0) {
                // MP3 option
                const mp3Option = createFormatOption('audio', 'Audio (MP3)', 'High quality audio (192kbps)', 'bestaudio[ext=m4a]/bestaudio', 'mp3');
                formatOptions.appendChild(mp3Option);
                
                // AAC option
                const aacOption = createFormatOption('audio', 'Audio (AAC)', 'High quality audio (AAC codec)', 'bestaudio[ext=m4a]/bestaudio', 'aac');
                formatOptions.appendChild(aacOption);
            }
        }
        
        // Create format option element
        function createFormatOption(type, title, details, formatId, outputFormat = 'video') {
            const option = document.createElement('div');
            option.className = 'format-option';
            option.onclick = () => selectFormat(option, formatId, outputFormat);
            
            option.innerHTML = `
                <div class="format-icon ${type}">
                    ${type === 'video' ? 'üé¨' : 'üéµ'}
                </div>
                <div class="format-info">
                    <div class="format-title">${title}</div>
                    <div class="format-details">${details}</div>
                </div>
            `;
            
            return option;
        }
        
        // Select format
        function selectFormat(element, formatId, outputFormat) {
            // Remove previous selection
            document.querySelectorAll('.format-option').forEach(opt => opt.classList.remove('selected'));
            
            // Add selection to clicked element
            element.classList.add('selected');
            
            // Store selected format
            selectedFormat = { formatId, outputFormat };
        }
        
        // Check if device is iOS
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent);
        }
        
        // Check if device is mobile
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        // Download selected format
        async function downloadSelectedFormat() {
            if (!selectedFormat || !currentVideoInfo) {
                alert('Please select a format first');
                return;
            }
            
            hideFormatSelection();
            showProgress();
            
            try {
                updateProgress(10, 'Preparing Download', 'Initializing download process...', '0 MB/s');
                
                const downloadResponse = await fetch('/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        url: currentVideoInfo.url,
                        format_id: selectedFormat.formatId,
                        output_format: selectedFormat.outputFormat
                    })
                });
                
                updateProgress(30, 'Downloading', 'Fetching video data...', '2.5 MB/s');
                
                if (!downloadResponse.ok) {
                    const errorText = await downloadResponse.text();
                    throw new Error('Failed to download: ' + errorText);
                }
                
                updateProgress(70, 'Processing', 'Converting and optimizing...', '1.8 MB/s');
                
                const downloadInfo = await downloadResponse.json();
                console.log('Download info:', downloadInfo);
                
                updateProgress(90, 'Finalizing', 'Preparing file for download...', '0.5 MB/s');
                
                // Add to download history
                addToDownloadHistory(downloadInfo);
                
                updateProgress(100, 'Complete!', 'Download finished successfully', '0 MB/s');
                
                // Show success with mobile-optimized download
                setTimeout(() => {
                    hideProgress();
                    const isVideo = selectedFormat.outputFormat === 'video';
                    const isIOSDevice = isIOS();
                    const isMobileDevice = isMobile();
                    
                    let downloadButton = '';
                    let additionalInfo = '';
                    
                    if (isIOSDevice && isVideo) {
                        // For iOS video downloads, use a special approach
                        downloadButton = `
                            <button class="download-btn" onclick="handleIOSDownload('${downloadInfo.download_url}', '${currentVideoInfo.title}.webm', false)" style="border: none; cursor: pointer;">
                                üì± Play & Save to Photos
                            </button>
                            <p style="font-size: 12px; opacity: 0.7; margin-top: 10px;">
                                Video will play in a popup - tap and hold to save to Photos
                            </p>
                        `;
                        const formatInfo = selectedFormat.formatId.includes('mp4') ? 
                            '<p style="color: #4ecdc4;">üì± MP4 Format: Direct compatibility with Photos</p>' :
                            '<p style="color: #ffd700;">üì± WebM Format: iOS will convert to MP4/H.264 in Photos</p>';
                        additionalInfo = formatInfo + '<p style="color: #ffd700;">üì± iOS: Video will be saved to your Photos app</p>';
                    } else if (isIOSDevice && !isVideo) {
                        // For iOS audio downloads, use a special approach
                        const audioExt = selectedFormat.output_format || 'mp3';
                        downloadButton = `
                            <button class="download-btn" onclick="handleIOSDownload('${downloadInfo.download_url}', '${currentVideoInfo.title}.${audioExt}', true)" style="border: none; cursor: pointer;">
                                üéµ Play & Save to Files
                            </button>
                            <p style="font-size: 12px; opacity: 0.7; margin-top: 10px;">
                                Audio will play in a popup - tap and hold to save to Files
                            </p>
                        `;
                        additionalInfo = `
                            <p style="color: #ffd700;">üéµ iOS: Save to Files ‚Üí Import to Apple Music via iTunes</p>
                            <div style="background: rgba(102, 126, 234, 0.1); padding: 15px; border-radius: 10px; margin-top: 10px; border-left: 4px solid #667eea;">
                                <h4 style="margin: 0 0 10px 0; color: #667eea;">üì± How to Add to Apple Music:</h4>
                                <ol style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.5;">
                                    <li>Save audio to Files app (Music folder)</li>
                                    <li>Connect iPhone to computer with iTunes</li>
                                    <li>Drag audio files from Files to iTunes</li>
                                    <li>Sync with iPhone to add to Apple Music</li>
                                </ol>
                                <p style="margin: 10px 0 0 0; font-size: 12px; opacity: 0.8;">
                                    üí° Alternative: Use Apple Music subscription to upload via iCloud Music Library
                                </p>
                            </div>
                        `;
                    } else if (isMobileDevice) {
                        // For other mobile devices
                        downloadButton = `
                            <a href="${downloadInfo.download_url}" class="download-btn" download>
                                üì• Download File
                            </a>
                            <p style="font-size: 12px; opacity: 0.7; margin-top: 10px;">
                                File will be saved to your Downloads folder
                            </p>
                        `;
                    } else {
                        // For desktop
                        downloadButton = `
                            <a href="${downloadInfo.download_url}" class="download-btn" download>
                                üì• Download File
                            </a>
                        `;
                    }
                    
                    const content = `
                        <h3>‚úÖ Download Complete!</h3>
                        <p><strong>${currentVideoInfo.title}</strong></p>
                        <p>Size: ${(downloadInfo.filesize / (1024 * 1024)).toFixed(1)} MB</p>
                        <p>Format: ${selectedFormat.outputFormat.toUpperCase()}</p>
                        ${additionalInfo}
                        ${downloadButton}
                    `;
                    showResult(content, true);
                }, 1500);
                
            } catch (error) {
                console.error('Download error:', error);
                hideProgress();
                
                let errorMessage = error.message;
                if (errorMessage.includes('Failed to download')) {
                    errorMessage = 'Download failed. Please check your internet connection and try again.';
                }
                
                const content = `
                    <h3>‚ùå Error</h3>
                    <p>${errorMessage}</p>
                    <p>Please try again.</p>
                `;
                showResult(content, false);
            }
        }
        
        // Event listeners
        document.getElementById('blackHole').addEventListener('click', async () => {
            const clipboardUrl = await checkClipboard();
            if (clipboardUrl) {
                await extractVideoInfo(clipboardUrl);
            } else {
                showUrlInput();
            }
        });
        
        document.getElementById('videosButton').addEventListener('click', () => {
            showRecentDownloads();
        });
        
        document.getElementById('closeUrlInput').addEventListener('click', hideUrlInput);
        document.getElementById('cancelUrl').addEventListener('click', hideUrlInput);
        
        document.getElementById('extractUrl').addEventListener('click', () => {
            const url = document.getElementById('videoUrl').value;
            if (url) {
                extractVideoInfo(url);
            }
        });
        
        document.getElementById('closeFormatSelection').addEventListener('click', hideFormatSelection);
        document.getElementById('backToUrl').addEventListener('click', () => {
            hideFormatSelection();
            showUrlInput();
        });
        
        document.getElementById('downloadSelected').addEventListener('click', downloadSelectedFormat);
        
        document.getElementById('closeRecentDownloads').addEventListener('click', hideRecentDownloads);
        document.getElementById('clearDownloads').addEventListener('click', clearAllDownloads);
        document.getElementById('newDownload').addEventListener('click', () => {
            hideRecentDownloads();
            showUrlInput();
        });
        
        // Audio controls
        document.getElementById('volumeSlider').addEventListener('input', (e) => {
            const volume = e.target.value;
            document.getElementById('volumeValue').textContent = volume + '%';
            updateVolumeIcon();
            
            if (currentAudio) {
                currentAudio.volume = volume / 100;
            }
        });
        
        document.getElementById('closeResult').addEventListener('click', hideResult);
        
        // Close modals when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target.id === 'urlInput') hideUrlInput();
            if (e.target.id === 'formatSelection') hideFormatSelection();
            if (e.target.id === 'progressContainer') hideProgress();
            if (e.target.id === 'recentDownloads') hideRecentDownloads();
            if (e.target.id === 'result') hideResult();
        });
        
        // Auto-focus URL input when shown
        document.getElementById('urlInput').addEventListener('transitionend', () => {
            if (document.getElementById('urlInput').style.display === 'flex') {
                document.getElementById('videoUrl').focus();
            }
        });
    </script>
</body>
</html>